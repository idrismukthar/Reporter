<!DOCTYPE html>
<html>
<head>
    <title><%= student.Name %> - Academic Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .no-print-btn { background: #6a0dad; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px auto; display: block; font-weight: bold; }
        .report-card { background: white; width: 210mm; margin: auto; padding: 10mm; border: 2px solid #6a0dad; box-sizing: border-box; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #6a0dad; padding-bottom: 8px; }
        .school-logo { width: 65px; height: 65px; object-fit: contain; }
        .student-photo { width: 80px; height: 90px; border: 1px solid #6a0dad; object-fit: cover; }
        .school-info h2 { color: #6a0dad; margin: 0; font-size: 18px; text-align: center; text-transform: uppercase; }
        .school-info p { margin: 1px 0; text-align: center; font-size: 9px; color: #333; }
        .title-banner { background: #6a0dad; color: white; text-align: center; padding: 4px; margin: 8px 0; font-weight: bold; font-size: 11px; }
        .info-bar { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 10px; margin: 5px 0; padding: 6px; background: #f9f9f9; border: 1px solid #ddd; font-size: 10px; }
        .performance-section { display: flex; gap: 8px; margin-top: 8px; }
        .main-table { flex: 3; }
        .side-stats-container { flex: 1.1; display: flex; flex-direction: column; gap: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #444; padding: 3px 5px; text-align: left; font-size: 10px; }
        th { background-color: #f2f2f2; font-size: 9px; }
        .summary-box { border: 1px solid #6a0dad; padding: 6px; background: #fff; }
        .summary-box p { margin: 2px 0; font-size: 10px; }
        .comment-area { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .comment-box { border: 1px solid #888; padding: 6px; height: 115px; position: relative; }
        .principal-font { font-family: 'Dancing Script', cursive; font-size: 14px; color: #1a1a1a; margin: 5px 0; line-height: 1.3;}
        .sig { position: absolute; bottom: 3px; right: 8px; border-top: 1px solid #000; width: 110px; text-align: center; font-size: 8px; }
        .footer-date { margin-top: 10px; font-size: 8px; color: #666; font-style: italic; border-top: 1px dotted #ccc; padding-top: 3px; }
    </style>
</head>
<body>

    <button class="no-print-btn" onclick="downloadPDF()">ðŸ“¥ Download Result PDF</button>

    <div class="report-card" id="result-sheet">
        <div class="header">
            <img src="/img/tlmps_llogo.png" class="school-logo" onerror="this.src='https://via.placeholder.com/70'">
            <div class="school-info">
                <h2>THE LEADERS MEMORIAL PRIVATE SCHOOL</h2>
                <p>Motto: We Nurture the Leaders of tomorrow</p>
                <p>Address: 17, Shoye Odubana Street, Off Papa Major B/stop, Ijegun-Ikotun, Lagos.</p>
                <p>Contact: contacttlmps@gmail.com | 08034417992 </p>
            </div>
            <img src="/img/<%= student.Passport %>" class="student-photo" onerror="this.src='https://via.placeholder.com/80x90'">
        </div>

        <div class="title-banner" style="text-align: left; padding-left: 10px;">
            1. PERSONAL BIO-DATA
        </div>

        <div class="info-bar">
            <div>
                <strong>FULL NAME:</strong> <%= student.Name %><br>
                <strong>ADMISSION NO:</strong> <%= student.Admission_no %>
            </div>
            <div>
                <strong>CLASS:</strong> <%= student.Class %><br>
                <strong>GENDER:</strong> <%= student.Sex %>
            </div>
            <div style="text-align: right;">
                <strong>TERM:</strong> <%= term.toUpperCase() %><br>
                <strong>SESSION:</strong> <%= session %>
            </div>
        </div>

        <div class="title-banner" style="margin-top: 5px; background: #6a0dad; text-align: left; padding-left: 10px;">
            2. ACADEMIC PERFORMANCE
        </div>

        <div class="performance-section">
            <div class="main-table">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 45%;">SUBJECTS OFFERED</th>
                            <th>CA (40)</th>
                            <th>EXAM (60)</th>
                            <th>TOTAL</th>
                            <th>REMARK</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% 
                            let currentTotal = 0;
                            scores.forEach(s => { 
                                currentTotal += s.total_score;
                                let gradeInfo;
                                if (s.total_score >= 70) gradeInfo = { g: 'A', r: 'EXCELLENT', c: '#6a0dad' };
                                else if (s.total_score >= 60) gradeInfo = { g: 'B', r: 'V. GOOD', c: '#2d0a4d' };
                                else if (s.total_score >= 50) gradeInfo = { g: 'C', r: 'GOOD', c: 'green' };
                                else if (s.total_score >= 45) gradeInfo = { g: 'D', r: 'PASS', c: 'orange' };
                                else gradeInfo = { g: 'F', r: 'FAIL', c: 'red' };
                        %>
                            <tr>
                                <td><%= s.subject.toUpperCase().replace(/_/g, ' ') %></td>
                                <td><%= s.ca_score %></td>
                                <td><%= s.exam_score %></td>
                                <td style="color: <%= gradeInfo.c %>; font-weight: bold;"><%= s.total_score %></td>
                                <td style="color: <%= gradeInfo.c %>; font-weight: bold; font-size: 8px;">
                                    <%= gradeInfo.g %> - <%= gradeInfo.r %>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>

            <div class="side-stats-container">
                <div class="summary-box">
                    <h4 style="margin: 0 0 4px 0; font-size: 10px; border-bottom: 1px solid #6a0dad;">3. SCORES SUMMARY</h4>
                    <p>Term 1 Average: <strong><%= t1Avg %>%</strong></p>
                    <% if (term.toLowerCase() === 'second term') { %>
                        <p>Term 2 Average: <strong><%= currentAvg %>%</strong></p>
                        <p style="color: #6a0dad; font-size: 12px;">Cumulative: <strong><%= cumulativeAvg %>%</strong></p>
                    <% } %>
                    <% if (term.toLowerCase() === 'third term') { %>
                        <p>Term 2 Average: <strong><%= t2Avg %>%</strong></p>
                        <p>Term 3 Average: <strong><%= currentAvg %>%</strong></p>
                        <p style="color: #6a0dad; font-size: 12px;">Cumulative: <strong><%= cumulativeAvg %>%</strong></p>
                    <% } %>
                    <p>Total Subjects Offered: <strong><%= totalSubjects %></strong></p>
                    <p>Class Position: <strong><%= position %></strong></p>
                    
                    <% if (promoMsg) { %>
                        <div style="margin-top: 10px; padding: 12px; background: #6a0dad; color: white; border-radius: 6px; text-align: center; font-weight: 900; font-size: 12px; text-transform: uppercase; box-shadow: 2px 2px 8px rgba(106, 13, 173, 0.4); border: 2px solid #9b30ff;">
                            <%= promoMsg %>
                        </div>
                    <% } %>
                </div>

                <div class="summary-box" style="margin-top: 5px;">
                    <h4 style="margin: 0 0 4px 0; font-size: 10px; border-bottom: 1px solid #6a0dad;">4. EXTRACURRICULAR PARTICIPATION</h4>
                    <table style="font-size: 9px;">
                        <tr>
                            <td style="font-weight: bold;">Club</td>
                            <td><%= student.club || 'N/A' %></td>
                        </tr>
                        <tr>
                            <td style="font-weight: bold;">Society</td>
                            <td><%= student.society || 'N/A' %></td>
                        </tr>
                    </table>
                </div>

                <div class="summary-box">
                    <h4 style="margin: 0 0 4px 0; font-size: 9px; border-bottom: 1px solid #6a0dad;">5. CHARACTER & CONDUCT</h4>
                    <p style="font-size: 8px; text-align: center; margin-bottom: 2px;">(Scale: 5=Excellent, 1=Fair)</p>
                    <table style="font-size: 8px;">
                        <tr><td>Punctuality</td><td style="width: 30px; text-align: center;"> </td></tr>
                        <tr><td>Neatness</td><td style="text-align: center;"> </td></tr>
                        <tr><td>Obedience</td><td style="text-align: center;"> </td></tr>
                        <tr><td>Honesty</td><td style="text-align: center;"> </td></tr>
                        <tr><td>Discipline</td><td style="text-align: center;"> </td></tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="comment-area">
            <div class="comment-box">
                <strong>CLASS TEACHER'S REMARK:</strong>
                <p class="principal-font"></p>
                <div class="sig">Teacher's Signature</div>
            </div>
            <div class="comment-box">
                <strong>PRINCIPAL'S REMARK:</strong>
                <p class="principal-font"><%= finalPrincipalRemark %></p>
                <div class="sig">Principal's Signature</div>
            </div>
        </div>

        <div class="footer-date">
            Date Printed: <%= new Date().toLocaleString('en-GB') %>
        </div>
    </div>

    <script>
    function downloadPDF() {
        const element = document.getElementById('result-sheet');
        
        // Clean Filename Logic
        const sName = "<%= student.Name.split(' ')[0] %>";
        const sClass = "<%= student.Class %>";
        const sTerm = "<%= term.replace(/\s+/g, '_') %>";
        const sSession = "<%= session.replace(/\//g, '_') %>";
        
        const fileName = `${sName}_${sClass}_${sTerm}_${sSession}.pdf`;

        const opt = {
            margin: 0,
            filename: fileName,
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 4, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }
    </script>
</body>
</html>